<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resumo - ControlTX</title>
<style>
:root {
  --bg: #0a0f1f;
  --card: #141c2f;
  --text: #e2e8f0;
  --accent: #f1dc18;
}
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background-color: var(--bg);
  color: var(--text);
}

/* Sidebar */
.sidebar {
  position: fixed;
  top:0;
  left:0;
  width:220px;
  height:100%;
  background-color: var(--card);
  padding:20px;
  box-sizing:border-box;
  transition: transform 0.3s ease;
  z-index:1000;
}
.sidebar h2 {margin-top:0;color:var(--accent);}
.sidebar a {
  display:block;
  color:var(--text);
  text-decoration:none;
  margin:10px 0;
  padding:8px 5px;
  border-radius:5px;
}
.sidebar a:hover {background-color: #1e40af33;}

/* Hamburger */
.hamburger {
  display:none;
  position:fixed;
  top:15px;
  left:15px;
  z-index:1100;
  cursor:pointer;
  flex-direction:column;
  gap:5px;
}
.hamburger div {
  width:25px;
  height:3px;
  background-color: var(--text);
  transition:0.3s;
}

/* Conte√∫do principal */
.main {
  margin-left:240px;
  padding:20px;
  transition: margin-left 0.3s ease;
}

/* Cards */
.cards {
  display:flex;
  flex-wrap:wrap;
  gap:20px;
}
.card {
  background-color: var(--card);
  padding:20px;
  border-radius:8px;
  flex:1 1 200px;
  box-shadow:0 2px 5px rgba(0,0,0,0.3);
  transition: transform 0.2s, box-shadow 0.2s;
}
.card:hover {
  transform: translateY(-5px);
  box-shadow:0 4px 10px rgba(0,0,0,0.5);
}
.card h3 {margin-top:0;color:var(--accent); display:flex; align-items:center; gap:5px;}
.card p {font-size:1.5em;margin:10px 0 0 0;}

/* Se√ß√£o mensagens do dia e alerta */
.section-card {
  background-color: var(--card);
  padding:20px;
  border-radius:8px;
  margin-top:20px;
  box-shadow:0 2px 5px rgba(0,0,0,0.3);
}

/* Alerta de vencimentos */
#alertaVencimentos {
  background-color:#ff4444;
  color:#fff;
}

/* Bot√µes */
button {
  background-color: var(--accent);
  color:#fff;
  border:none;
  padding:10px 15px;
  border-radius:5px;
  cursor:pointer;
  margin-top:10px;
}
button:hover {background-color:#1e40afcc;}

/* Lista clientes vencendo */
#listaClientesVencendo li{
  margin-bottom:5px;
}

/* Responsivo */
@media(max-width:768px){
  .sidebar {transform:translateX(-100%);}
  .sidebar.active {transform:translateX(0);}
  .main {margin-left:0;}
  .hamburger {display:flex;}
}
</style>
</head>
<body>

<!-- Hamburger -->
<div class="hamburger" id="hamburger"><div></div><div></div><div></div></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <h2>MJ Tecnologia</h2>
  <a href="index.html" data-tab="dashboard">Dashboard</a>
  <a href="cliente.html">Clientes</a>
  <a href="emprestimo.html">Empr√©stimos</a>
  <a href="config.html">Configura√ß√µes</a>
</div>

<!-- Conte√∫do principal -->
<div class="main" id="main">

  <!-- Dashboard -->
  <section id="dashboard" class="active">
    <h1>üìä Resumo - ControlTX</h1>

    <!-- Alerta de vencimentos -->
    <div id="alertaVencimentos" class="section-card" style="display:none;">
      <p id="mensagemVencimentos"></p>
      <ul id="listaClientesVencendo"></ul>
      <button id="btnEnviarVencimentos">Enviar Mensagens Agora</button>
    </div>

    <!-- Cards resumo -->
    <div class="cards">
      <div class="card"><h3>üí∞ Total Emprestado</h3><p id="totalEmprestado">R$ 0,00</p></div>
      <div class="card"><h3>üìà Empr√©stimos Ativos</h3><p id="emprestimosAtivos">0</p></div>
      <div class="card"><h3>üè¶ Total Recebido</h3><p id="totalRecebido">R$ 0,00</p></div>
      <div class="card"><h3>üíµ Lucro Estimado (Juros)</h3><p id="lucroJuros">R$ 0,00</p></div>
      <div class="card"><h3>üë• Total de Clientes</h3><p id="totalClientes">0</p></div>
    </div>

    <!-- Bot√£o enviar mensagens do dia -->
    <div class="section-card">
      <h3>üì§ Mensagens do Dia</h3>
      <button id="enviarMensagensDia">Enviar Mensagens do Dia</button>
    </div>
  </section>

</div>

<script>
// Menu lateral toggle
const hamburger = document.getElementById('hamburger');
const sidebar = document.getElementById('sidebar');
const main = document.getElementById('main');

hamburger.addEventListener('click', ()=>{ sidebar.classList.toggle('active'); });
main.addEventListener('click', ()=>{ if(sidebar.classList.contains('active')) sidebar.classList.remove('active'); });

// Fun√ß√µes de resumo
function formatCurrency(value){ 
  return value.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); 
}

function atualizarResumo(){
  const emprestimos = JSON.parse(localStorage.getItem('emprestimos'))||[];
  let totalEmprestado=0, totalRecebido=0, lucroJuros=0, emprestimosAtivos=0;
  const clientes = new Set();

  emprestimos.forEach(emp=>{
    const valor=parseFloat(emp.valor)||0;
    const pago=emp.pago?parseFloat(emp.valorPago||emp.valor||0):0;
    const juros=parseFloat(emp.juros||0);

    totalEmprestado+=valor;
    totalRecebido+=pago;
    lucroJuros+=(emp.pago?juros:0);
    if(!emp.pago) emprestimosAtivos++;
    if(emp.cliente) clientes.add(emp.cliente);
  });

  document.getElementById('totalEmprestado').textContent=formatCurrency(totalEmprestado);
  document.getElementById('totalRecebido').textContent=formatCurrency(totalRecebido);
  document.getElementById('lucroJuros').textContent=formatCurrency(lucroJuros);
  document.getElementById('emprestimosAtivos').textContent=emprestimosAtivos;
  document.getElementById('totalClientes').textContent=clientes.size;
}

// Fun√ß√£o enviar mensagem WhatsApp
function enviarMensagemWhatsApp(cliente, valor, chavePix, numeroWhatsApp) {
  const mensagem = `Ol√° ${cliente},\n\nO seu empr√©stimo no valor de R$ ${valor.toFixed(2)} vence hoje.\nPor favor, realize o pagamento via PIX para a chave: ${chavePix}.\n\nObrigado!`;
  const link = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensagem)}`;
  window.open(link, '_blank');
}

// Fun√ß√£o para detectar se a data √© hoje (qualquer formato)
function isHoje(dataStr) {
  if(!dataStr) return false;
  const hoje = new Date();
  const data = new Date(dataStr.split('/').reverse().join('-')); // tenta DD/MM/YYYY -> YYYY-MM-DD
  return hoje.getFullYear() === data.getFullYear() &&
         hoje.getMonth() === data.getMonth() &&
         hoje.getDate() === data.getDate();
}

// Verificar vencimentos hoje e exibir alerta com lista de clientes
function verificarVencimentosHoje(){
  const emprestimos = JSON.parse(localStorage.getItem('emprestimos')) || [];
  const perfil = JSON.parse(localStorage.getItem('perfilProprietario')) || {};
  const numeroWhatsApp = perfil.whatsapp || '';
  const chavePix = perfil.pix || '';

  const vencendoHoje = emprestimos.filter(emp => !emp.pago && isHoje(emp.dataVencimento));

  const alertaDiv = document.getElementById('alertaVencimentos');
  const mensagem = document.getElementById('mensagemVencimentos');
  const listaClientes = document.getElementById('listaClientesVencendo');

  if(vencendoHoje.length > 0){
    alertaDiv.style.display = 'block';
    mensagem.textContent = `‚ö†Ô∏è Existem ${vencendoHoje.length} empr√©stimo(s) vencendo hoje:`;

    // Limpar lista anterior
    listaClientes.innerHTML = '';
    vencendoHoje.forEach(emp=>{
      const li = document.createElement('li');
      li.textContent = emp.cliente;
      listaClientes.appendChild(li);
    });

    document.getElementById('btnEnviarVencimentos').onclick = ()=>{
      if(!numeroWhatsApp || !chavePix){
        alert('Por favor, cadastre WhatsApp e PIX do propriet√°rio em Configura√ß√µes.');
        return;
      }
      vencendoHoje.forEach(emp=>{
        enviarMensagemWhatsApp(emp.cliente, parseFloat(emp.valor), chavePix, numeroWhatsApp);
      });
      alert(`${vencendoHoje.length} mensagem(ns) prontas para envio!`);
    };
  } else {
    alertaDiv.style.display = 'none';
  }
}

// Bot√£o enviar mensagens do dia (manual)
document.getElementById('enviarMensagensDia').addEventListener('click', ()=>{
  const emprestimos = JSON.parse(localStorage.getItem('emprestimos')) || [];
  const perfil = JSON.parse(localStorage.getItem('perfilProprietario')) || {};
  const numeroWhatsApp = perfil.whatsapp || '';
  const chavePix = perfil.pix || '';

  if(!numeroWhatsApp || !chavePix){
    alert('Por favor, cadastre WhatsApp e PIX do propriet√°rio em Configura√ß√µes.');
    return;
  }

  let count = 0;
  emprestimos.forEach(emp=>{
    if(!emp.pago && isHoje(emp.dataVencimento)){
      enviarMensagemWhatsApp(emp.cliente, parseFloat(emp.valor), chavePix, numeroWhatsApp);
      count++;
    }
  });

  if(count === 0) alert('Nenhum empr√©stimo vence hoje.');
  else alert(`${count} mensagem(ns) prontas para envio!`);
});

// Inicializa√ß√£o
window.onload = ()=>{
  atualizarResumo();
  verificarVencimentosHoje();
};
window.addEventListener('storage', event=>{
  if(event.key==='emprestimos') {
    atualizarResumo();
    verificarVencimentosHoje();
  }
});
</script>

</body>
</html>
